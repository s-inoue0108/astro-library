---
import Layout from "../../../../layouts/Layout.astro";
import PageTitle from "../../../../components/blog/background/PageTitle.astro";
import CategoriesNavBar from "../../../../components/blog/background/CategoriesNavBar.astro";
import ArticleCard from "../../../../components/blog/card/ArticleCard.astro";
import TagsListModal from "../../../../components/common/modal/TagsListModal.vue";
import ArchivesListModal from "../../../../components/common/modal/ArchivesListModal.vue";
import NoContent from "../../../../components/blog/background/NoContent.astro";
import { getArticles, getCategories, getTags } from "../../../../lib/newt/client";
import type { Article, Tag } from "../../../../lib/newt/types";
import type { Page, GetStaticPathsOptions } from "astro";
import { svgPaths, svgViewBoxes } from "../../../../lib/svg/paths";

export const getStaticPaths = async ({ paginate }: { paginate: GetStaticPathsOptions["paginate"] }) => {
	const tags = await getTags();
	const articles = await getArticles();

	if (!tags || tags.length <= 0 || !articles || articles.length <= 0) {
		return null;
	}

	const routes = tags.flatMap((tag) => {
		const filteredArticles = articles.filter((article) => {
			return article.tags && article.tags.length > 0 && article.tags.map((tag) => tag.slug).includes(tag.slug);
		});
		return paginate(filteredArticles, {
			params: { tagSlug: tag.slug },
			pageSize: 12,
			props: { tag: tag },
		});
	});
	return routes;
};

// Props
interface Props {
	page: Page<Article>;
	tag: Tag;
}

const { page, tag } = Astro.props;

const articles = await getArticles();
const categories = await getCategories();
const tags = await getTags();
---

<Layout title={`${tag.name}の記事一覧 | ページ${page.currentPage} | ブログ | ${import.meta.env.APP_NAME}`} description={`タグ "${tag.name}" の記事一覧です`}>
	<PageTitle title={tag.name} bgImage={tag.parentCategory.image} iconImage={tag.icon} svgIconPath={svgPaths.tag} svgViewBox={svgViewBoxes.tag} />
	<CategoriesNavBar />
	<ul class="cards">
		{
			page.data && page.data.length !== 0 ? (
				page.data.map((article) => {
					return (
						<li class="article-card">
							<ArticleCard article={article} />
						</li>
					);
				})
			) : (
				<NoContent message="記事がありません" />
			)
		}
	</ul>
	<TagsListModal categories={categories} tags={tags} client:visible />
	<ArchivesListModal articles={articles} client:visible />
</Layout>

<script>
	import { gsap } from "gsap";
	import { ScrollTrigger } from "gsap/ScrollTrigger";
	gsap.registerPlugin(ScrollTrigger);

	const cards = gsap.utils.toArray(".article-card");

	cards.forEach((elm: any) => {
		gsap.from(elm, {
			ease: "expo.out",
			duration: 1.5,
			xPercent: 50,
			autoAlpha: 0,
			overflowX: "hidden",
			scrollTrigger: {
				trigger: elm,
			},
		});
	});
</script>

<style lang="scss">
	.cards {
		overflow-x: hidden;
		width: 100%;
		margin: auto;
		display: flex;
		flex-direction: column;
		gap: 1rem;

		@include resp(lg) {
			flex-direction: row;
			flex-wrap: wrap;
		}

		.article-card {
			width: 100%;
			height: 256px;

			@include resp(lg) {
				width: calc(50% - 0.5rem);
			}

			@include resp(xl) {
				width: calc(25% - 0.25rem - 8px);
			}
		}
	}
</style>
../../../../components/common/modal/TagsListModal.vue
